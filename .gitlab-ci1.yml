image: registry.nces.by/aismv/docker:20.10.3

services:
  - docker:20.10.3-dind
  - maven:3.6.3-openjdk-8-slim
  - kubectl:1.20.2

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_VERIFY: 0
  DOCKER_TLS_CERTDIR: ""
  CDIR: "DynamicFormatSystem"

stages:
  - compile-test
  - build-push-docker
  - deploy-k8s

before_script:
  - docker info

compile:
  image: maven:3.6.3-openjdk-8-slim
  stage: compile-test
  script:
    - docker run -it --rm -v "$PWD":/usr/src -v aismv-misc-m2cache:/root/.m2 -v "$PWD/target:/usr/src/aismv/"$CDIR"/target" -w /usr/src/aismv/"$CDIR" maven:3.6.3-openjdk-8-slim mvn clean package
    
build:
  stage: build-push-docker
  script:
    - docker build -t registry.nces.by/aismv/back/aismv-back-dfs:$BUILD_NUMBER -f Dockerfile_nces .
    - docker push registry.nces.by/aismv/back/aismv-back-dfs:$BUILD_NUMBER
    - docker rmi registry.nces.by/aismv/back/aismv-back-dfs:$BUILD_NUMBER


release-image:
  stage: release
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
    - docker push $CONTAINER_RELEASE_IMAGE
  only:
    - master

deploy:
  stage: deploy
  script:
    - ./deploy.sh
  only:
    - master
